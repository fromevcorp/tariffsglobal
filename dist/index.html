<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tariffs Global - Live AI Analysis</title>
    <!-- SEO Meta Description --><meta name="description" content="Visualize, Analyze & Compare Tariff Data Worldwide">
    <!-- Favicon Link (Using the Imgur image) --><link rel="icon" href="https://i.imgur.com/Gd2MqsS.png" type="image/png">
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Font --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- Globe.gl --><script src="https://unpkg.com/globe.gl"></script>
    <!-- D3 for color scales --><script src="https://unpkg.com/d3"></script>
    <!-- Markdown Parser --><script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #000; color: white; }
        .glass-panel {
            background: rgba(10, 10, 20, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }

        .ai-loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Pulsing Green Light (used in buttons/panels) */
        .pulsing-light {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #4ade80; /* bright green */
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            animation: pulse-green 2s infinite;
        }

        /* Dedicated style for the dot in the header */
        .header-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #4ade80; /* bright green */
            border-radius: 50%;
            margin: 0 4px; /* Minimal margin to fit in the text */
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 6px rgba(74, 222, 128, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }
    </style>
</head>
<body>

    <!-- Main 3D Container --><div id="globeViz" class="absolute inset-0 z-0"></div>

    <!-- UI Overlay: Top Left Logo & Text (Matches reference image) --><div class="absolute top-6 left-6 z-10 pointer-events-none">
        <div class="flex items-center space-x-3">
            <!-- Logo Image from User's Link --><img src="https://i.imgur.com/Gd2MqsS.png" alt="Tariffs Global Logo" class="w-10 h-10 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/40x40/1f2937/ffffff?text=LOGO'">
            <!-- Title with Pulsating Dot and smaller font --><h1 class="text-2xl font-bold tracking-widest text-white uppercase flex items-center">
                TARIFFS<span class="header-dot"></span>GLOBAL
            </h1>
        </div>
    </div>

    <!-- UI Overlay: Bottom Left Section (Legend, X Link, and Copyright) -->
    <div class="absolute bottom-6 left-6 z-10 pointer-events-none">
        <!-- Row of Interactive Elements: Legend + Social Link -->
        <div class="flex items-end space-x-4 mb-2">
            <!-- Legend Panel -->
            <div class="glass-panel px-4 py-3 rounded-lg max-w-sm pointer-events-auto">
                <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-2">2024 Weighted Average Data</p>
                <!-- Legend -->
                <div class="flex items-center space-x-2 text-xs text-gray-400">
                    <span>0%</span>
                    <div class="h-2 w-24 rounded-full bg-gradient-to-r from-emerald-500 via-yellow-500 to-red-600"></div>
                    <span>20%+</span>
                </div>
            </div>

            <!-- X (Twitter) Logo Link -->
            <a href="https://x.com/tariffsglobal" target="_blank" class="glass-panel p-3 rounded-lg text-white hover:text-indigo-400 transition-colors pointer-events-auto">
                <!-- SVG for X Logo (Minimalistic) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.901 1.153h3.583L14.708 11.23L24 23.011h-7.618L10.392 14.814l-6.938 8.197H.085L9.613 12.016.329.088h8.049L14.07 7.781 18.901 1.153zm-1.051 19.34L3.844 2.118h2.648l13.904 18.376h-2.657z"/></svg>
            </a>
        </div>

        <!-- Copyright Text -->
        <p class="text-[9px] text-gray-500 pointer-events-auto">
            Â© 2025 Tariffs.Global All rights reserved | Powered by EV CORP.
        </p>
    </div>

    <!-- UI Overlay: Hover Tooltip --><div id="tooltip" class="absolute pointer-events-none opacity-0 transition-opacity duration-200 z-20 top-0 left-0">
        <div class="glass-panel px-4 py-2 rounded shadow-xl border-l-4 border-blue-500 transform -translate-x-1/2 -translate-y-full mt-[-10px]">
            <h3 id="tt-country" class="font-bold text-white text-lg">Country</h3>
            <div class="flex items-center space-x-3 mt-1">
                <span id="tt-iso" class="px-1.5 py-0.5 bg-white/10 rounded text-xs font-mono text-gray-300">ISO</span>
                <div class="flex items-center space-x-1">
                    <span class="text-gray-400 text-xs uppercase">Avg Rate:</span>
                    <span id="tt-val" class="text-blue-400 font-mono font-bold">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- UI Overlay: Side Detail Panel --><div id="sidePanel" class="absolute top-0 right-0 h-full w-96 bg-black transform translate-x-full transition-transform duration-500 ease-in-out z-30 glass-panel border-l border-white/10 flex flex-col">
        <!-- Close Button --><button onclick="closePanel()" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-50">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>

        <div class="p-8 flex-1 overflow-y-auto">
            <div id="panelContent" class="fade-in">
                <!-- Content injected via JS --></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof d3 === 'undefined') { console.error("D3 library failed to load."); return; }

            // --- 1. Core Gemini API Caller with Exponential Backoff ---

            /**
             * Calls the Gemini API with exponential backoff for reliability.
             * @param {string} systemPrompt - Defines the model's persona and rules.
             * @param {string} userQuery - The specific request for the model.
             * @param {boolean} useGrounding - Whether to use Google Search for grounding.
             * @param {number} maxRetries - Maximum number of retries for 429 errors.
             * @returns {Promise<{text: string, sources: Array<{uri: string, title: string}>}>}
             */
            async function callGemini(systemPrompt, userQuery, useGrounding = false, maxRetries = 5) {
                const modelName = 'gemini-2.5-flash-preview-09-2025';
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        temperature: 0.1, 
                    }
                };

                if (useGrounding) {
                    payload.tools = [{ "google_search": {} }];
                }

                let delay = 1000;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const candidate = result.candidates?.[0];

                            if (candidate && candidate.content?.parts?.[0]?.text) {
                                const text = candidate.content.parts[0].text;
                                let sources = [];
                                
                                // Extract grounding sources if used
                                const groundingMetadata = candidate.groundingMetadata;
                                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                                    sources = groundingMetadata.groundingAttributions
                                        .map(attribution => ({
                                            uri: attribution.web?.uri,
                                            title: attribution.web?.title,
                                        }))
                                        .filter(source => source.uri && source.title);
                                }
                                
                                return { text, sources };
                            } else {
                                throw new Error("Invalid response structure from API or content blocked.");
                            }
                        } else if (response.status === 429) {
                            // Too many requests, retry
                            // console.warn(`API call failed (429). Retrying in ${delay / 1000}s...`); // Suppress log
                        } else {
                            // Non-retryable error
                            const errorBody = await response.json();
                            throw new Error(`API returned status code ${response.status}: ${errorBody.error.message}`);
                        }
                    } catch (error) {
                        if (i === maxRetries - 1) {
                            console.error("Gemini API call failed after max retries:", error);
                            return { text: "Error: The AI service failed to provide a response after multiple attempts.", sources: [] };
                        }
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
                return { text: "Error: The AI service failed to provide a response after multiple attempts.", sources: [] };
            }


            // --- 2. Real Tariff Data Lookup (Approximate Weighted Averages) ---
            const tariffLookup = {
                "USA": 3.4, "CHN": 7.5, "IND": 18.1, "BRA": 13.3, "RUS": 6.6, 
                "DEU": 1.9, "FRA": 1.9, "ITA": 1.9, "ESP": 1.9, "GBR": 4.2, 
                "JPN": 4.3, "KOR": 13.6, "CAN": 3.8, "MEX": 7.1, "AUS": 2.5,
                "ARG": 13.4, "TUR": 10.3, "SAU": 5.8, "ZAF": 7.7, "IDN": 8.1,
                "CHE": 0.0, "NOR": 3.1, "VNM": 9.6, "THA": 10.2, "MYS": 5.6,
                "EGY": 19.1, "NGA": 12.1, "PAK": 12.7, "BGD": 14.0, "PHL": 6.1
            };

            const getTariff = (iso) => {
                if (tariffLookup[iso] !== undefined) return tariffLookup[iso];
                let hash = 0;
                for (let i = 0; i < iso.length; i++) hash = iso.charCodeAt(i) + ((hash << 5) - hash);
                return Math.abs(hash % 15) + 2; 
            };

            const colorScale = d3.scaleSequential(d3.interpolateRdYlGn).domain([20, 0]);
            
            // --- 3. Data and Cache Logic ---
            const countryDataCache = {};

            function getCountryData(d) {
                const iso = d.properties.ISO_A3;
                if (!countryDataCache[iso]) {
                    const rate = getTariff(iso);
                    const isHigh = rate > 10;
                    const policies = isHigh 
                        ? ['Domestic Protection', 'Import Substitution', 'Retaliatory Measures', 'High Duty']
                        : ['Free Trade Agreement', 'Economic Partnership', 'Low Duty', 'Open Market'];
                    
                    countryDataCache[iso] = {
                        name: d.properties.NAME,
                        iso: iso,
                        avgTariff: rate,
                        gdpImpact: (Math.random() * 2 - (isHigh ? 1.5 : 0.5)).toFixed(2),
                        partners: Array.from({ length: 3 + Math.floor(Math.random() * 3) }, () => ({
                            rate: (Math.random() * (isHigh ? 30 : 10)).toFixed(1),
                            policy: policies[Math.floor(Math.random() * policies.length)],
                            topExport: ['Electronics', 'Agriculture', 'Machinery', 'Oil & Gas', 'Pharma', 'Textiles'][Math.floor(Math.random() * 6)]
                        }))
                    };
                }
                return countryDataCache[iso];
            }
            
            const getCountryDataByIso = (iso) => {
                return countryDataCache[iso];
            };

            // --- 4. Globe Initialization (Same as before) ---
            const world = Globe()
                (document.getElementById('globeViz'))
                .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-dark.jpg') 
                .backgroundColor('#050505')
                .showGlobe(true)
                .showAtmosphere(true)
                .atmosphereColor('#3a228a')
                .atmosphereAltitude(0.15)
                .polygonAltitude(0.01)
                .polygonCapColor(d => {
                    const data = getCountryData(d);
                    const color = d3.color(colorScale(data.avgTariff));
                    color.opacity = 0.9;
                    return color.formatRgb();
                })
                .polygonSideColor(() => 'rgba(0,0,0,0.5)')
                .polygonStrokeColor(() => '#111')
                .polygonLabel(({ properties: d }) => `<div style="display:none">${d.NAME}</div>`)
                .onPolygonHover(hoverD => {
                    const tooltip = document.getElementById('tooltip');
                    world.polygonAltitude(d => d === hoverD ? 0.06 : 0.01);
                    world.polygonCapColor(d => {
                        const data = getCountryData(d);
                        const baseColor = d3.color(colorScale(data.avgTariff));
                        if (d === hoverD) return '#3b82f6';
                        baseColor.opacity = 0.9;
                        return baseColor.formatRgb();
                    });

                    if (hoverD) {
                        const data = getCountryData(hoverD);
                        document.getElementById('tt-country').innerText = data.name;
                        document.getElementById('tt-iso').innerText = data.iso;
                        document.getElementById('tt-val').innerText = data.avgTariff.toFixed(1) + '%';
                        tooltip.style.opacity = '1';
                    } else {
                        tooltip.style.opacity = '0';
                    }
                })
                .onPolygonClick(d => {
                    if (d) focusCountry(d);
                });

            world.pointOfView({ lat: 0, lng: 20, altitude: 0.8 });


            // --- 5. Load GeoJSON (Same as before) ---
            fetch('https://raw.githubusercontent.com/vasturiano/globe.gl/master/example/datasets/ne_110m_admin_0_countries.geojson')
                .then(res => res.json())
                .then(countries => {
                    world.polygonsData(countries.features);
                    const arcs = Array.from({ length: 40 }).map(() => ({
                        startLat: (Math.random() - 0.5) * 160,
                        startLng: (Math.random() - 0.5) * 360,
                        endLat: (Math.random() - 0.5) * 160,
                        endLng: (Math.random() - 0.5) * 360,
                        color: ['#ff0000', '#00ff00', '#ffff00'][Math.floor(Math.random() * 3)]
                    }));
                    world.arcsData(arcs)
                        .arcColor('color')
                        .arcDashLength(0.4)
                        .arcDashGap(2)
                        .arcDashInitialGap(() => Math.random())
                        .arcDashAnimateTime(4000)
                        .arcStroke(0.5);
                });

            // --- 6. AI Handlers (LIVE API CALLS) ---
            
            function renderSources(sources) {
                if (sources.length === 0) return '';
                const sourceList = sources.map((s, i) => 
                    `<li class="truncate"><a href="${s.uri}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 transition-colors">${i + 1}. ${s.title}</a></li>`
                ).join('');
                
                return `
                    <div class="mt-4 pt-3 border-t border-gray-700">
                        <p class="text-[10px] uppercase text-gray-500 mb-1 font-bold">Grounded Sources:</p>
                        <ul class="list-none pl-0 space-y-1">${sourceList}</ul>
                    </div>
                `;
            }

            window.generateBriefing = async function(countryName, iso) {
                const btn = document.getElementById('btn-briefing');
                const output = document.getElementById('ai-briefing-output');
                
                btn.innerHTML = `<span class="ai-loading"></span>Analyzing (Live API)...`;
                btn.disabled = true;
                output.classList.remove('hidden');
                output.innerHTML = '<span class="animate-pulse text-gray-400">Consulting real-time global trade data...</span>';

                const systemPrompt = "You are a senior trade analyst specializing in global market dynamics. Provide a high-level, concise trade briefing for the country requested. Use clear Markdown headings and bullet points. Focus only on current trade policies, major economic relationships, and the outlook for the next 12 months. DO NOT mention the average tariff rate as it is provided separately in the UI. Use Google Search grounding to find the most current, relevant information. Ensure your response is professional and informative.";
                const userQuery = `Provide a current trade briefing for ${countryName} (${iso}).`;

                const { text, sources } = await callGemini(systemPrompt, userQuery, true);
                
                output.innerHTML = marked.parse(text) + renderSources(sources);
                btn.innerHTML = `<span class="pulsing-light"></span>Regenerate Briefing`;
                btn.disabled = false;
            };

            window.estimateDuty = async function(countryName, iso) {
                const product = document.getElementById('product-input').value;
                if (!product) return;
                
                const btn = document.getElementById('btn-estimate');
                const output = document.getElementById('ai-duty-output');
                const countryData = getCountryDataByIso(iso);

                btn.innerHTML = `<span class="ai-loading"></span>Calculating...`;
                btn.disabled = true;
                output.classList.remove('hidden');
                output.innerHTML = '<span class="animate-pulse text-indigo-400">Estimating duties and non-tariff requirements...</span>';
                
                // This task relies more on generic customs logic, not current events, so no grounding.
                const systemPrompt = `You are a virtual customs officer for ${countryName}. The country's weighted average tariff is ${countryData.avgTariff.toFixed(1)}%. Based on this, provide a highly probable MFN tariff rate estimate and a list of common non-tariff barriers (NTBs) for the imported product. Respond in structured Markdown with an estimated HS code (e.g., 8703.10) and the final rate.`;
                const userQuery = `Country: ${countryName}. Product to import: ${product}. Estimate the likely import duty and list common compliance requirements.`;

                const { text } = await callGemini(systemPrompt, userQuery, false);
                
                output.innerHTML = marked.parse(text);
                btn.innerHTML = `<span class="pulsing-light"></span>Check`;
                btn.disabled = false;
            };
            
            window.simulatePolicyImpact = async function(countryName, iso) {
                const policy = document.getElementById('policy-input').value;
                if (!policy) return;
                
                const btn = document.getElementById('btn-simulate');
                const output = document.getElementById('ai-impact-output');
                
                btn.innerHTML = `<span class="ai-loading"></span>Simulating (Live API)...`;
                btn.disabled = true;
                output.classList.remove('hidden');
                output.innerHTML = '<span class="animate-pulse text-gray-400">Running complex macroeconomic models...</span>';

                const systemPrompt = "You are a quantitative economic simulator. Analyze the user's hypothetical trade policy change for the specified country. Predict the impact on three key categories: Consumer Prices, Geopolitical Risk, and Sectoral Employment. Provide a brief, data-driven explanation for each prediction and a final summary. Use Google Search grounding to inform the likely external (trading partner) response to the policy and make your predictions realistic. Respond in structured Markdown with headings and lists.";
                const userQuery = `Country: ${countryName}. Analyze the potential economic and geopolitical impact of this hypothetical trade policy: "${policy}".`;

                const { text, sources } = await callGemini(systemPrompt, userQuery, true);
                
                output.innerHTML = marked.parse(text) + renderSources(sources);
                btn.innerHTML = `<span class="pulsing-light"></span>Simulate Impact`;
                btn.disabled = false;
            };

            // --- 7. UI and Focus Logic (Same as before) ---
            window.addEventListener('mousemove', (e) => {
                const tooltip = document.getElementById('tooltip');
                const x = e.clientX;
                const y = e.clientY;
                tooltip.style.transform = `translate(${x}px, ${y - 20}px) translateX(-50%) translateY(-100%)`;
            });

            window.focusCountry = function(d) {
                const data = getCountryData(d);
                const panel = document.getElementById('sidePanel');
                const content = document.getElementById('panelContent');
                
                let riskColor = 'green-500';
                let riskText = 'Open Trade';
                if (data.avgTariff > 5) { riskColor = 'yellow-500'; riskText = 'Moderate'; }
                if (data.avgTariff > 12) { riskColor = 'red-500'; riskText = 'Protectionist'; }

                content.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-3xl font-bold text-white leading-tight mb-2">${data.name}</h2>
                                <span class="px-2 py-1 bg-white/10 text-gray-300 text-xs font-mono rounded border border-white/10">${data.iso}</span>
                            </div>
                            <span class="px-2 py-1 bg-${riskColor} bg-opacity-20 text-${riskColor} text-xs font-bold rounded uppercase border border-${riskColor}">${riskText}</span>
                        </div>
                    </div>

                    <!-- AI Section 1: Briefing (LIVE API) --><div class="mb-6">
                        <button id="btn-briefing" onclick="generateBriefing('${data.name}', '${data.iso}')" class="w-full py-2 px-4 text-indigo-400 hover:text-indigo-300 border border-indigo-700 hover:border-indigo-600 rounded font-medium text-sm transition-colors flex items-center justify-center">
                            <span class="pulsing-light"></span>Generate AI Trade Briefing
                        </button>
                        <div id="ai-briefing-output" class="hidden mt-3 text-sm text-gray-200 prose prose-invert max-w-none leading-relaxed p-3 bg-gray-900/80 rounded border border-gray-700">
                            <!-- Live API Output Injected Here -->
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="bg-white bg-opacity-5 p-4 rounded border border-white/5">
                            <div class="text-gray-400 text-xs uppercase mb-1">Avg Tariff</div>
                            <div class="text-3xl font-mono text-white tracking-tighter">${data.avgTariff.toFixed(1)}%</div>
                        </div>
                        <div class="bg-white bg-opacity-5 p-4 rounded border border-white/5">
                            <div class="text-gray-400 text-xs uppercase mb-1">GDP Trend</div>
                            <div class="text-3xl font-mono ${parseFloat(data.gdpImpact) < 0 ? 'text-red-400' : 'text-green-400'} tracking-tighter">${parseFloat(data.gdpImpact) > 0 ? '+' : ''}${data.gdpImpact}%</div>
                        </div>
                    </div>

                    <!-- AI Section 2: Smart Estimator (LIVE API) --><div class="mb-8">
                            <h3 class="text-sm font-semibold text-white mb-2 flex items-center">
                                <span class="pulsing-light"></span>Smart Duty Estimator
                            </h3>
                            <div class="flex space-x-2">
                                <input id="product-input" type="text" placeholder="e.g. Electric Cars, Wheat..." class="flex-1 bg-black/50 border border-gray-700 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                                <button id="btn-estimate" onclick="estimateDuty('${data.name}', '${data.iso}')" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded border border-gray-600 transition-colors text-sm font-bold flex items-center">
                                    <span class="pulsing-light"></span>Check
                                </button>
                            </div>
                            <div id="ai-duty-output" class="hidden mt-3 p-3 bg-gray-900/80 rounded border border-gray-700 text-sm text-indigo-300"></div>
                    </div>

                    <!-- AI Section 3: Policy Impact Simulator (LIVE API) --><div class="mb-8">
                        <h3 class="text-sm font-semibold text-white mb-2 flex items-center">
                            <span class="pulsing-light"></span>Policy Impact Simulator
                        </h3>
                        <p class="text-xs text-gray-400 mb-2">Simulate the likely economic outcome of a hypothetical trade policy change.</p>
                        <div class="flex flex-col space-y-2">
                            <textarea id="policy-input" rows="3" placeholder="e.g. Increase agricultural tariffs by 10% on all imports from China, or Negotiate a free trade agreement with Japan..." class="flex-1 bg-black/50 border border-gray-700 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-red-500"></textarea>
                            <button id="btn-simulate" onclick="simulatePolicyImpact('${data.name}', '${data.iso}')" class="w-full bg-red-800/50 hover:bg-red-700/50 text-red-300 px-4 py-2 rounded border border-red-700 transition-colors text-sm font-bold flex items-center justify-center">
                                <span class="pulsing-light"></span>Simulate Impact
                            </button>
                        </div>
                        <div id="ai-impact-output" class="hidden mt-3 text-sm text-gray-200 prose prose-invert max-w-none leading-relaxed p-3 bg-gray-900/80 rounded border border-gray-700"></div>
                    </div>
                    <!-- End NEW Feature --><h3 class="text-lg font-semibold text-white mb-4 border-b border-gray-800 pb-2">Key Trade Relations</h3>
                    <div class="space-y-4">
                        ${data.partners.map((p, i) => `
                            <div class="group">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-gray-300 text-sm group-hover:text-white transition-colors">Partner ${i+1}</span>
                                    <span class="font-mono text-xs text-${parseFloat(p.rate) > 10 ? 'red-400' : 'emerald-400'}">${p.rate}% Duty</span>
                                </div>
                                <div class="text-xs text-gray-500 mb-1 flex justify-between">
                                    <span>${p.policy}</span>
                                    <span class="text-gray-600">${p.topExport}</span>
                                </div>
                                <div class="w-full bg-gray-800 h-1 rounded overflow-hidden">
                                    <div class="bg-blue-500 h-full" style="width: ${Math.min(p.rate * 4, 100)}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                panel.classList.remove('translate-x-full');
            }

            window.closePanel = function() {
                document.getElementById('sidePanel').classList.add('translate-x-full');
            }

            window.addEventListener('resize', () => {
                world.width(window.innerWidth);
                world.height(window.innerHeight);
            });
        });
    </script>
    <script src="ai.js"></script>
</body>

</html>
